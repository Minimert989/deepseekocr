<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë””ë²„ê·¸ í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #0f0;
        }
        .log {
            background: #000;
            padding: 20px;
            border-radius: 5px;
            max-height: 500px;
            overflow-y: auto;
            margin: 20px 0;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
        }
        input {
            padding: 10px;
            margin: 5px;
            width: 400px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” OCR ì‹œìŠ¤í…œ ë””ë²„ê·¸ í…ŒìŠ¤íŠ¸</h1>
    
    <div>
        <h2>1. ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸</h2>
        <button onclick="testServer()">ì„œë²„ ì—°ê²° í™•ì¸</button>
        <div id="serverResult"></div>
    </div>
    
    <div>
        <h2>2. íŒŒì¼ ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸</h2>
        <input type="file" id="testFile" accept=".pdf">
        <input type="text" id="testToken" placeholder="HF Token">
        <button onclick="testUpload()">ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸</button>
        <div id="uploadResult"></div>
    </div>
    
    <div>
        <h2>3. SSE ìŠ¤íŠ¸ë¦¬ë° í…ŒìŠ¤íŠ¸</h2>
        <input type="text" id="sessionId" placeholder="Session ID">
        <button onclick="testStream()">ìŠ¤íŠ¸ë¦¼ í…ŒìŠ¤íŠ¸</button>
        <button onclick="stopStream()">ìŠ¤íŠ¸ë¦¼ ì¤‘ì§€</button>
    </div>
    
    <div class="log" id="logOutput"></div>
    
    <script>
        let eventSource = null;
        
        function log(message, color = '#0f0') {
            const logDiv = document.getElementById('logOutput');
            const line = document.createElement('div');
            line.style.color = color;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(line);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        async function testServer() {
            log('ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘...', '#ff0');
            try {
                const response = await fetch('/');
                log(`ì„œë²„ ì‘ë‹µ: ${response.status} ${response.statusText}`, '#0f0');
                document.getElementById('serverResult').innerHTML = 
                    `<span style="color: #0f0;">âœ… ì„œë²„ ì •ìƒ</span>`;
            } catch (error) {
                log(`ì„œë²„ ì˜¤ë¥˜: ${error.message}`, '#f00');
                document.getElementById('serverResult').innerHTML = 
                    `<span style="color: #f00;">âŒ ì„œë²„ ì˜¤ë¥˜: ${error.message}</span>`;
            }
        }
        
        async function testUpload() {
            const fileInput = document.getElementById('testFile');
            const token = document.getElementById('testToken').value;
            
            if (!fileInput.files[0]) {
                log('íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”', '#f00');
                return;
            }
            
            if (!token) {
                log('í† í°ì„ ì…ë ¥í•˜ì„¸ìš”', '#f00');
                return;
            }
            
            log('íŒŒì¼ ì—…ë¡œë“œ ì‹œì‘...', '#ff0');
            
            const formData = new FormData();
            formData.append('pdf', fileInput.files[0]);
            formData.append('hf_token', token);
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                log(`ì—…ë¡œë“œ ì‘ë‹µ ìƒíƒœ: ${response.status}`, '#0ff');
                
                const result = await response.json();
                log(`ì—…ë¡œë“œ ê²°ê³¼: ${JSON.stringify(result)}`, '#0f0');
                
                document.getElementById('uploadResult').innerHTML = 
                    `<pre style="color: #0f0;">${JSON.stringify(result, null, 2)}</pre>`;
                
                if (result.success) {
                    log('ì´ì œ /process ì—”ë“œí¬ì¸íŠ¸ë¥¼ í˜¸ì¶œí•˜ì„¸ìš”', '#ff0');
                    
                    // ìë™ìœ¼ë¡œ ì²˜ë¦¬ ì‹œì‘
                    const processResponse = await fetch('/process', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            filename: result.filename,
                            hf_token: token
                        })
                    });
                    
                    const processResult = await processResponse.json();
                    log(`ì²˜ë¦¬ ì‹œì‘ ê²°ê³¼: ${JSON.stringify(processResult)}`, '#0f0');
                    
                    if (processResult.success) {
                        document.getElementById('sessionId').value = processResult.session_id;
                        log(`Session ID ì €ì¥ë¨: ${processResult.session_id}`, '#0ff');
                        log('ì´ì œ "ìŠ¤íŠ¸ë¦¼ í…ŒìŠ¤íŠ¸" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”', '#ff0');
                    }
                }
                
            } catch (error) {
                log(`ì—…ë¡œë“œ ì˜¤ë¥˜: ${error.message}`, '#f00');
                document.getElementById('uploadResult').innerHTML = 
                    `<span style="color: #f00;">âŒ ${error.message}</span>`;
            }
        }
        
        function testStream() {
            const sessionId = document.getElementById('sessionId').value;
            
            if (!sessionId) {
                log('Session IDë¥¼ ì…ë ¥í•˜ì„¸ìš”', '#f00');
                return;
            }
            
            log(`ìŠ¤íŠ¸ë¦¼ ì—°ê²° ì‹œë„: /stream/${sessionId}`, '#ff0');
            
            if (eventSource) {
                eventSource.close();
            }
            
            eventSource = new EventSource(`/stream/${sessionId}`);
            
            eventSource.onopen = function() {
                log('âœ… SSE ì—°ê²° ì„±ê³µ!', '#0f0');
            };
            
            eventSource.onmessage = function(event) {
                log(`ğŸ“¨ ë©”ì‹œì§€ ìˆ˜ì‹ : ${event.data}`, '#0ff');
                
                try {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'log') {
                        log(`  ğŸ“‹ ë¡œê·¸: ${data.message}`, '#fff');
                    } else if (data.type === 'complete') {
                        log('ğŸ‰ ì²˜ë¦¬ ì™„ë£Œ!', '#0f0');
                        eventSource.close();
                    } else if (data.type === 'error') {
                        log(`âŒ ì˜¤ë¥˜: ${data.message}`, '#f00');
                        eventSource.close();
                    } else if (data.type === 'ping') {
                        log('ğŸ’“ Ping', '#666');
                    }
                } catch (e) {
                    log(`JSON íŒŒì‹± ì˜¤ë¥˜: ${e.message}`, '#f00');
                }
            };
            
            eventSource.onerror = function(error) {
                log(`âŒ SSE ì˜¤ë¥˜ ë°œìƒ`, '#f00');
                log(`ReadyState: ${eventSource.readyState}`, '#f00');
                log(`Error: ${JSON.stringify(error)}`, '#f00');
            };
        }
        
        function stopStream() {
            if (eventSource) {
                eventSource.close();
                log('ìŠ¤íŠ¸ë¦¼ ì—°ê²° ì¢…ë£Œ', '#ff0');
                eventSource = null;
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„œë²„ í…ŒìŠ¤íŠ¸
        window.onload = () => {
            testServer();
        };
    </script>
</body>
</html>
